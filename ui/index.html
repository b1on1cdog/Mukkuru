<!DOCTYPE html>
<html lang="en" class="notranslate" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Mukkuru</title>
    <link rel="stylesheet" href="./assets/css/theme.css">
    <script src="mukkuru.js"></script>
    <script src="localization.js"></script>
    <script>
const cssOverride = document.createElement('style');
//at this point we do not have access to userConfiguration, so we are using localStorage
if (localStorage.getItem("darkMode") == "true") {
    applyDarkMode();
}

function measure_time(name, begin, end = performance.now()) {
    time_used = end - begin;
    backend_log(name + " " + time_used + " ms");
}

let currentRow = 1;
let currentIndex = 0;

function sendBackgroundColorToParent(color) {
  window.parent.postMessage({ bgColor: color }, '*');
}

document.addEventListener('DOMContentLoaded', () => {
    const start_load = performance.now();
    /*Load games*/
    const gameList = document.querySelector('.gameList');
    const appList = document.querySelector('.appList');
    const mediaList = document.querySelector('.mediaList');
    appLaunchers = document.querySelector('.appLauncher');
    gameLaunchers = document.querySelectorAll('.gameLauncher');
    homeMenu = document.getElementsByClassName("homeMenu")[0];
    mediaItems = document.querySelectorAll('.videoLauncher');

    if (localStorage.getItem("userGestureRequired") == "false") {
        isUserGestureRequired = false;
    } else {
        isUserGestureRequired = window.self !== window.top;
    }
    /*
        Mukkuru should have it's own game source, since some users might want games outside
        from Steam or they might want to include/exclude some games from it
    */
    const root = document.documentElement; // This is the <html> element
    const styles = getComputedStyle(root);
    const displayHero = styles.getPropertyValue('--display-hero').trim() == "1";
    const hideBottomBar = styles.getPropertyValue('--hide-bottom-bar').trim() == "1";
    const footerButtonBg = styles.getPropertyValue('--footer-button-bg').trim();
    const darkModeAccentColor = styles.getPropertyValue('--dark-mode-accent-color').trim();
    const darkModeSelectBorder = styles.getPropertyValue('--dark-mode-select-border').trim();
    const darkFooterButtonBg = styles.getPropertyValue('--dark-footer-button-bg').trim();
    const allSoftwareThumbnailURL = styles.getPropertyValue('--all-software-thumbnail').trim().slice(1, -1);
    backend_log(allSoftwareThumbnailURL);
    listColumns = Number(styles.getPropertyValue('--applist-columns').trim());
    const useGlass = styles.getPropertyValue('--use-glass').trim() == "1";
    const appListCols = (listColumns == 0 || isNaN(listColumns) )?6:listColumns;
    backend_log("Using "+appListCols+" columns")
    if (footerButtonBg != "") {
        document.querySelectorAll(".footerButton").forEach((element) => element.style.backgroundColor = "rgba(0, 0, 0, 0)");
    }

    fetch("/config/get").then(function(response) {
        return response.json();
    }).then(function(data) {
        userConfiguration = data;
        measure_time("config loading time", start_load)

        if (userConfiguration != null && userConfiguration != undefined && Object.keys(userConfiguration).length > 0) {
            localStorage.setItem("userConfiguration", JSON.stringify(data));
            backend_log("[debug] config is ready");
            configReady();
        } else {
            backend_log(`[debug] config init failed ${userConfiguration} ${userConfiguration.length}`);
        }

        if (userConfiguration["darkMode"] == true) {
        /*
        We will get the colors from CSS, this way if colors need to be changed in future,
        only css modifications are needed.
        */
        if (localStorage.getItem("darkMode") != "true") {
            backend_log("[debug] new session with darkMode enabled");
            localStorage.setItem("darkMode", true);
            applyDarkMode();
        } else {
            backend_log("[debug] using existing session");
        }

        if (darkModeSelectBorder != "") {
            document.documentElement.style.setProperty("--select-border", darkModeSelectBorder);
        }

        document.getElementsByClassName("homeMenu")[0].style.setProperty("--bg-color", darkColor);
        if (darkFooterButtonBg != ""){
            document.querySelectorAll(".footerButton").forEach((element) => element.style.backgroundColor = darkFooterButtonBg); //this one must be slightly different to background
        }
        document.querySelectorAll(".footerButton-icon").forEach((element) => {
            if (element instanceof SVGElement) {
                element.getElementsByTagName("path")[0].style.fill = lightColor;
            }
        });
        document.getElementsByClassName("controllerState-type")[0].getElementsByTagName("svg")[0].getElementsByTagName("path")[0].style.fill = lightColor;
        document.getElementsByClassName("wifiState-icon")[0].getElementsByTagName("path")[0].style.fill = lightColor;
        document.querySelectorAll(".keyGuide-icon").forEach((element) => element.getElementsByTagName("path")[0].style.fill = lightColor);
        if (darkModeAccentColor != "") {
            document.documentElement.style.setProperty("--accent-color", darkModeAccentColor);
        }
    }

    clockUpdate(userConfiguration["12H"]);
    setInterval(() => {
        clockUpdate(userConfiguration["12H"]);
    }, 30000);
    setInterval(() => {
        isAlive();
    }, 3000);
    showKeyGuide(userConfiguration["showKeyGuide"]);
    if (userConfiguration["displayBatteryPercent"]) {
        document.getElementById("batteryPercent").style.display = "block";
    }
    allowRendering();
    const bg = document.getElementsByClassName("homeMenu")[0].style.backgroundColor;
    sendBackgroundColorToParent(bg);
    refreshServer();
    (async () => {
    await isLocalizationReady;
    if (isUserGestureRequired) {
        backend_log("running in kiosk mode, showing overlay...");
        document.getElementById('overlay').style.display = 'flex';
        overlayMessage = document.getElementById('overlay-message');
        overlayMessage.dataset.original = overlayMessage.innerText;
        overlayMessage.innerText = translate_str("pressToStart", "Press 'confirm' button to continue.")
    }
    })();

    });
    fetch("/library/get").then(function(response) {
        return response.json();
    }).then(function(data) {
    /*
    We are using an IIFE because we need to wait for config to be initialized.
    */
    (async () => {
    library_start = performance.now();
    //gameArr = Object.entries(data);
    gameArr = Object.entries(data);
    const favoriteGames = new Set(userConfiguration.favorite);
    const recentPlayed = new Set(userConfiguration.recentPlayed);

    gameArray = [
        ...gameArr.filter(([key]) => recentPlayed.has(key)),
        ...gameArr.filter(([key]) => favoriteGames.has(key) && !recentPlayed.has(key)),
        ...gameArr.filter(([key, val]) => !recentPlayed.has(key) && !favoriteGames.has(key) && val.Thumbnail === true),
        ...gameArr.filter(([key, val]) => !recentPlayed.has(key) && !favoriteGames.has(key) && val.Thumbnail !== true)
    ];
    
    gamesSkipped = 0;
    gamesAdded = 0;
    await isConfigReady;

    gameLimit = userConfiguration["maxGamesInHomeScreen"];

    gameArray.forEach((item) => {
        const AppID = item[0];
        box_src = './thumbnails/'+AppID+'.jpg';

        if (item[1]["Thumbnail"]) {

        } else if (userConfiguration["skipNoArt"] == true){
            gamesSkipped++;
            return;
        } else {
            box_src = "./assets/vector/missing.svg";
        }

        if (userConfiguration["blacklist"].includes(AppID)){
            gamesSkipped++;
            return;
        }

        const button = document.createElement('button');
        button.className = 'gameLauncher';
        button.id = AppID;
        button.dataset.gameid = AppID;
        if (favoriteGames.has(AppID)){
            button.classList.add("favorite");
        }
        let proton = false;
        if ("Proton" in item[1] && item[1]["Proton"] == true ) {
            proton = true;
        }
        button.dataset.proton = proton;

        const title = document.createElement('div');
        title.className = 'gameLauncher-title';
        title.textContent = item[1]["AppName"];
        title.dataset.text = title.textContent;

        const thumbnail = document.createElement('img');
        thumbnail.className = 'gameLauncher-thumbnail';
        thumbnail.src = box_src;
        thumbnail.alt = item[1]["AppName"];

        button.appendChild(title);
        button.appendChild(thumbnail);
        if (useGlass) {
            const glass = document.createElement('div');
            glass.className = 'glass-effect';
            button.appendChild(glass);
        }

        if (gameLimit > gamesAdded){
            gameList.appendChild(button);
            gamesAdded++;
        }
       // (async () => {
        const app = document.createElement('button');
        app.className = 'appLauncher';
        if (favoriteGames.has(AppID)){
            app.classList.add("favorite");
        }
        app.dataset.proton = proton;
        app.id = "app_" + AppID;
        app.dataset.gameid = AppID;
        const appTitle = document.createElement('div');
        appTitle.className = "appLauncher-title";
        appTitle.textContent = item[1]["AppName"]
        appTitle.dataset.text = appTitle.textContent;
        const appImage = document.createElement('img');
        appImage.className = 'appLauncher-thumbnail';
        appImage.src = box_src;
        appImage.alt = item[1]["AppName"];
        app.appendChild(appTitle);
        app.appendChild(appImage);
        appList.appendChild(app);
      //  });
    });

    if (gamesAdded >= gameLimit) {
        backend_log("Game limit exceeded, creating all-software button");
        const moreButton = document.createElement('button');
        moreButton.className = 'gameLauncher-more';
        moreButton.id = "allSoftware";

        const thumbnail = document.createElement('img');
        thumbnail.className = 'gameLauncher-icon';

        if (allSoftwareThumbnailURL != "") {
            thumbnail.src = allSoftwareThumbnailURL;
        } else {
            thumbnail.src = "assets/img/all-software.png";
        }

        const title = document.createElement('div');
        title.className = 'gameLauncher-title';
        title.id = "allSoftware-title";
        title.textContent = "All Software";
        title.dataset.trm = "swapText";
        title.dataset.loc = "AllSoftware";
        title.dataset.text = title.textContent;
        moreButton.appendChild(title);
        moreButton.appendChild(thumbnail);
        gameList.appendChild(moreButton);
    }
    
    gameLaunchers = document.querySelectorAll('.gameLauncher, .gameLauncher-more');
    appLaunchers = document.querySelectorAll('.appLauncher');

    document.querySelectorAll('.gameLauncher-placeholder').forEach(e => e.remove());
    
    if (gameLaunchers.length < userConfiguration["maxGamesInHomeScreen"]){
        blocksToAdd = userConfiguration["maxGamesInHomeScreen"] - gameLaunchers.length;
        while (blocksToAdd > 0) {
            // This might be unnecesary
            blocksToAdd--;
            const block = document.createElement('button');
            block.className = 'gameLauncher-placeholder';
            block.disabled = true;
            gameList.appendChild(block);
        }
    }
    
    const spacer = document.createElement('div');
    spacer.style.minWidth = "300px";
    gameList.appendChild(spacer);

    appLaunchers.forEach(item => {
        item.addEventListener('focus', () => {
            item.scrollIntoView({ behavior: "instant", block: "center" });
        });
    });

    if (displayHero) {
        bg = document.getElementById("bg");
        bg.style.backgroundRepeat = "no-repeat";
        bg.style.backgroundSize = "cover";
        bg.style.backgroundPosition = "center";
        homeMenu.style.backgroundColor = "none";
    }

    gameLaunchers.forEach(item => {
        item.addEventListener('focus', () => {
            item.scrollIntoView({ behavior: "instant", block: "center", inline: "center" });
            if (displayHero) {//start displayHero
                if (!item.classList.contains("gameLauncher-more")) {
                    bg.style.backgroundImage = "url('hero/" + item.id+ ".png')";
                } else{
                    bg.style.backgroundImage = "none";
                }
            }//end displayHero
        });
    });

    utilityButtons.forEach(item => {
        item.addEventListener('focus', () => {
            item.scrollIntoView({ behavior: "smooth", block: "center", inline: "center" });
            if (displayHero && !userConfiguration["darkMode"]) {
                bg.style.backgroundImage = "unset";
            }
        });
    });

    backend_log("[debug] Skipped " + gamesSkipped + " games due to user settings");
                
    if (gameLaunchers.length > 0){
    gameLaunchers[0].focus(); // Focus the first game by default

    document.querySelectorAll(".gameLauncher-title").forEach(el => {
    if (el.textContent.length > 25) {//32
            el.innerHTML = `<span>${el.innerHTML}</span>`;
            }
        });
    } else {
        backend_log(`[debug] no games -> arr-length ${gameArray.length}, gameLimit ${gameLimit}, gamesAdded ${gamesAdded}, userConfiguration ${userConfiguration}`);
    }

    measure_time("library loading time", library_start)
})();//END IIFE
    }).catch(function(err) {
        backend_log('[error] Fetch Error :'+ err);
    });

    const utilityButtons = Array.from(document.querySelectorAll('.footerNavigation button'));
    const profileRow = document.querySelectorAll('.userList-user');

    fetch("/username").then(function(response) {
        return response.text();
    }).then(function(data) {
        profileRow[0].dataset.username = data;
    }).catch(function(err) {
        console.log('Fetch Error :-S', err);
    });
    fetch_proton_list();
    fetch_videos();
    const proton_ctx_menu = document.createElement('div');
    proton_ctx_menu.className = "contextItem";
    proton_ctx_menu.innerText = "Proton";
    proton_ctx_menu.id = "proton_ctx";
    setTimeout(() => {
        proton_ctx_menu.innerText = protonList[0];
    }, "1000");

    function refreshCtxMenu(){
        currentApp = (currentRow == 1)?gameLaunchers[currentIndex]:appLaunchers[currentIndex];
        isGameRow =  (currentRow == 1 || currentRow == 3)
        gameId = currentApp.dataset.gameid;
        if (isGameRow && currentApp.classList.contains("favorite")){
            document.getElementById("fvOption").innerText = translate_str("removeFavorite", "Remove from favorite");
        }  else {
            document.getElementById("fvOption").innerText = translate_str("addFavorite", "Add as favorite");
        }
        if (isGameRow && userConfiguration.blacklist.includes(gameId) ) {
            document.getElementById("blOption").innerText = translate_str("showGame", "Show game");
        } else {
            document.getElementById("blOption").innerText = translate_str("hideGame", "Hide game");
        }

        if (isGameRow){
            ctxMenu = document.getElementsByClassName("contextualMenu active")[0];
            isProtonSet = currentApp.dataset.proton == "true";
            if (isProtonSet) {
                currentProton = userConfiguration.protonConfig[gameId];
                if (currentProton == undefined) {
                    proton_ctx_menu.innerText = protonList[0];
                } else {
                    proton_ctx_menu.innerText = currentProton;
                }
                
            }
            if (isProtonSet && !proton_ctx_menu.isConnected){
                ctxMenu.appendChild(proton_ctx_menu);
            } else if (!isProtonSet && proton_ctx_menu.isConnected) {
                ctxMenu.removeChild(proton_ctx_menu);
            }
        }

    }
    document.getElementById("back-keyGuide").style.display = "none";
    document.addEventListener('click', (e) => {
        backend_log("user gesture no longer required, reason: click");
        userGestureNoLongerRequired();
    }, { once: true });
    window.addEventListener('message', (event) => { 
        if (event.data == "userGestureNoLongerRequired") {
            backend_log("user gesture no longer required, reason: parent message");
            userGestureNoLongerRequired();
        }
     }, {once:true})

    document.addEventListener('keydown', (e) => {
         e.preventDefault();
        //ensureFullscreen(!userConfiguration["fullScreen"]);
        if (homeMenu.style.opacity < 1) {
            return;
        }
        const eventRef = Math.floor(Math.random() * 9001)
        tick = true;
        let navigatingRow = [profileRow, gameLaunchers, utilityButtons, appLaunchers];
        let cols = [1, gameLaunchers.length, 6, appLaunchers.length];
        
        if (lockControls) {
            return;
        }
        //i do not want to bloat a single file with too much code, i'll transfer controls to mukkuru.js
        if (isVideoPlayer) {
            videoControl(keyBindings[e.key]);
            return;
        }

        if (currentRow == 4 && !isContextMenu) {
            document.getElementById("back-keyGuide").style.display = "flex";
            document.getElementById("options-keyGuide").style.display = "flex";
            if (mediaItems.length == 0) {
                mediaItems = document.querySelectorAll('.videoLauncher');
            }
            mediaControl(keyBindings[e.key]);
            return;
        }
        ctxMenu = document.getElementsByClassName("contextualMenu active")[0];

        if (isUserGestureRequired && keyBindings[e.key] == "confirm") {
            backend_log("user gesture no longer required, reason: confirmed");
            userGestureNoLongerRequired();
            return;
        } else if (isUserGestureRequired) {
            return;
        }
        
        switch (keyBindings[e.key]) {
            case "options":
                if (currentRow == 1 && currentIndex < gameLimit || currentRow == 3) {
                    isContextMenu = true;
                    document.getElementById("gameContextMenu").classList.add("active");
                    refreshCtxMenu();
                    playSound("select");
                }
                break;
            case "up":
                if (isContextMenu) {
                    if (currentContext == 0)
                    {
                        playSound("border")
                        return;
                    }
                    playSound("select");
                    currentContext--;
                    selectedContext = ctxMenu.getElementsByClassName("contextItem selected")[0];
                    selectedContext.classList.remove("selected");
                    selectedContext.previousElementSibling.classList.add("selected");
                    return;
                }
                if (currentRow == 0) {
                    playSound("border");
                } else if (currentRow == 3 && currentIndex > 5) {
                    currentIndex = currentIndex - appListCols;
                    playSound("select");
                } else if (currentRow == 3 && currentIndex < 6) {
                    currentIndex = 0;
                    playSound("border");
                } else {
                    currentIndex = 0;
                    currentRow = currentRow - 1;
                    playSound("select");
                    if (currentRow == 1 && gameLaunchers.length == 0){
                        currentRow = 0;
                    }
                }
                break;
            case "down":
                if (isContextMenu) {
                    ctxMax = ctxMenu.querySelectorAll('.contextItem').length;
                    if (currentContext >= ctxMax-1) {
                        playSound("border");
                        return
                    }
                    playSound("select");
                    currentContext++;
                    selectedContext = ctxMenu.getElementsByClassName("contextItem selected")[0];
                    selectedContext.classList.remove("selected");
                    selectedContext.nextElementSibling.classList.add("selected");
                    return;
                }
                if (currentRow == 2) {
                    playSound("border");
                } else if (currentRow == 3 && currentIndex + appListCols < navigatingRow[currentRow].length) {
                    currentIndex = currentIndex + appListCols;
                    playSound("select");
                } else if (currentRow == 3 && currentIndex + appListCols >= navigatingRow[currentRow].length) {
                    currentIndex = navigatingRow[currentRow].length-1;
                    playSound("border");
                } else {
                    currentIndex = 0
                    currentRow = currentRow + 1;
                    playSound("select");
                    if (currentRow == 1 && gameLaunchers.length == 0){
                        currentRow = 2;
                    }
                }
                break;
            case "left":
                if (isContextMenu) {
                    selectedContext = ctxMenu.getElementsByClassName("contextItem selected")[0];
                    if (selectedContext.id == "proton_ctx") {
                        playSound("select");
                        index = wrapIndex(protonList.indexOf(proton_ctx_menu.innerText) - 1, protonList.length);
                        proton_ctx_menu.innerText = protonList[index];
                        AppID = navigatingRow[currentRow][currentIndex].dataset.gameid;
                        setGameProperty("proton", AppID, proton_ctx_menu.innerText);
                    }
                    return;
                }
                if (currentIndex == 0 && !userConfiguration["loop"]) {
                    playSound("border");
                } else if (currentIndex == 0) {
                    currentIndex = cols[currentRow]-1
                    playSound("select");
                } else {
                    currentIndex = (currentIndex - 1 + navigatingRow[currentRow].length) % navigatingRow[currentRow].length;
                    playSound("select");
                }
                break;
            case "right":
                if (isContextMenu) {
                    selectedContext = ctxMenu.getElementsByClassName("contextItem selected")[0];
                    if (selectedContext.id == "proton_ctx") {
                        playSound("select");
                        index = wrapIndex(protonList.indexOf(proton_ctx_menu.innerText) + 1, protonList.length);
                        proton_ctx_menu.innerText = protonList[index];
                        AppID = navigatingRow[currentRow][currentIndex].dataset.gameid;
                        setGameProperty("proton", AppID, proton_ctx_menu.innerText);
                    }
                    return;
                }
                if (currentIndex == cols[currentRow]-1 && !userConfiguration["loop"]) {
                    playSound("border");
                } else if (currentIndex == cols[currentRow]-1) {
                    currentIndex = 0;
                    playSound("select");
                } else {
                    currentIndex = (currentIndex + 1) % navigatingRow[currentRow].length;
                    playSound("select");
                }
                break;
            case "confirm":
                if (isContextMenu){
                    selectedContext = ctxMenu.getElementsByClassName("contextItem selected")[0];
                    selectedContext.click();
                    playSound("tick");
                    if (currentContext == 0 && ctxMenu.id == "gameContextMenu") {
                        let app = appLaunchers[currentIndex];//document.getElementById("app_"+game.id);
                        let game = gameLaunchers[currentIndex];
                        if (app.classList.contains("favorite")) {
                            app.classList.remove("favorite");
                            if (game != undefined) {
                                game.classList.remove("favorite");
                            }
                        } else {
                            app.classList.add("favorite");
                            if (game != undefined) {
                                game.classList.add("favorite");
                            }
                        }
                    }
                    refreshCtxMenu();
                    return;
                }
                if (document.activeElement.id == "allSoftware") {
                    playSound("run");
                    setTimeout(function () {
                    currentRow = 3;
                    gameList.style.display = "none";
                    document.getElementsByClassName("homeHeader")[0].style.display = "none";
                    document.getElementsByClassName("footerNavigation")[0].style.display = "none";
                  //  document.getElementsByClassName("appheaders")[0].style.display = "flex";
                    appList.style.display = "grid";
                    currentIndex = 0;
                    }, 300);
                    blink(homeMenu);
                } else if(document.activeElement === gameLaunchers[currentIndex]) {
                    console.log("launching game....");
                    navigatingRow[currentRow][currentIndex].click();
                    AppID = navigatingRow[currentRow][currentIndex].dataset.gameid;
                    fetch("/library/launch/"+AppID).then(function(response) {
                        return response.text();
                    }).then(function(data) {
                        console.log(data);                        
                    });
                    playSound("run");
                } else if(document.activeElement === appLaunchers[currentIndex]) {
                    console.log("launching game....");
                    navigatingRow[currentRow][currentIndex].click();
                    AppID = navigatingRow[currentRow][currentIndex].dataset.gameid;
                    fetch("/library/launch/"+AppID).then(function(response) {
                        return response.text();
                    }).then(function(data) {
                        console.log(data);                        
                    });
                    playSound("run");
                } else if (currentRow == 2){
                    switch (currentIndex) {
                        case 0:
                            fetch("/library/scan").then(function(response) {
                                return response.json();
                            }).then(function(data){
                                window.location.reload();
                            });
                        playSound("enter-back");
                        break;
                        case 1:
                            isContextMenu = true;
                            document.getElementById("storeContextMenu").classList.add("active");
                            refreshCtxMenu();
                            playSound("select");
                            break;
                        case 2:
                            if (mediaItems.length == 0) {
                                mediaItems = document.querySelectorAll('.videoLauncher');
                                if (mediaItems.length == 0) {
                                    playSound("border");
                                    document.getElementById("emptyContext").classList.add("active");
                                    setTimeout(function () {
                                        document.getElementById("emptyContext").classList.remove("active");
                                    }, 1000);
                                    return;
                                }
                            }
                            playSound("run");
                            setTimeout(function () {
                                currentRow = 4;
                                gameList.style.display = "none";
                                document.getElementsByClassName("homeHeader")[0].style.display = "none";
                                document.getElementsByClassName("footerNavigation")[0].style.display = "none";
                                mediaList.style.display = "grid";
                                currentIndex = 0;
                            }, 300);
                            blink(homeMenu);
                            break;
                        case 3:
                            document.getElementById("controlContextMenu").classList.add("active");
                            isContextMenu = true;
                            handleAutoPlay("update");
                            playSound("tick");
                            break;
                        case 4:
                            playSound("settings");
                            vanish(homeMenu);
                            sleep(500).then(() => {
                                window.location.replace("/frontend/settings")
                            });    
                            break;
                        case 5:
                            document.getElementById("powerDownContextMenu").classList.add("active");
                            isContextMenu = true;
                            //refreshCtxMenu();
                            playSound("tick");
                            break;
                        default:
                            console.log("no action specified");
                            playSound("run");
                            break;
                    }
                }
                return;
            case "back":
                if (isContextMenu) {
                    close_context_menu();
                    return;
                }
                if (currentRow == 3){
                    goHome();
                }

        }

        if (currentRow < 3 || isContextMenu) {
            document.getElementById("back-keyGuide").style.display = "none";
        } else {
            document.getElementById("back-keyGuide").style.display = "flex";
        }

        if (currentRow == 1 && currentIndex < gameLimit || currentRow == 3) {
            document.getElementById("options-keyGuide").style.display = "flex";
        } else {
            document.getElementById("options-keyGuide").style.display = "none";
        }

        if (currentRow != 2 && hideBottomBar) {
            showBottomBar(false);
        } else if (currentRow != 3) {
            showBottomBar(true);
        }

        const scrollingText = styles.getPropertyValue('--game-title-scrolling-text').trim() == "1";

        if (currentRow == 1 && scrollingText){
        let launchers = (currentRow == 1)?gameLaunchers:appLaunchers;
        let titleDOM = (currentRow == 1)?".gameLauncher-title":".appLauncher-title";

        if (launchers.length > 0) {
        title = launchers[currentIndex].querySelectorAll(titleDOM)[0];
        if (title.dataset.text.length > 25){
        const span = title.querySelectorAll(titleDOM+" span");
        title.textContent = (title.dataset.text).slice(0,24);
        oEventRef = eventRef;
        setTimeout(() => {
            if (eventRef == oEventRef){
                if (title.dataset.text.length > 25){
                    title.innerHTML = "<span>" +title.dataset.text + "</span>";
                }
                console.log(title.dataset.text);
            }
        }, 2000);
    }

        }

        }

        navigatingRow[currentRow][currentIndex].focus();
    });
});


</script>
</head>
<body>
    <video id="videoPlayer" disablepictureinpicture controlsList="nofullscreen disablepictureinpicture noremoteplayback"></video>
    <div id="flash"></div>
    <div id="videoTime">00:00/00:00</div>
    <article class="homeMenu pending">
        <header class="homeHeader">
            <div class="background-layer" id="bg"></div>
            <div class="userList">
                <a href="#" class="userList-user" data-username="User">
                    <img class="userList-icon" src="./assets/avatar" alt="User Picture">
                </a>
            </div>
            <div class="statusBar">
                <svg id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" width="200" height="200" style="shape-rendering: auto; background: transparent;" xmlns:xlink="http://www.w3.org/1999/xlink"><g><circle stroke-linecap="round" fill="none" stroke-dasharray="50.26548245743669 50.26548245743669" stroke="#fe718d" stroke-width="6" r="32" cy="50" cx="50">
                    <animateTransform values="0 50 50;360 50 50" keyTimes="0;1" dur="1s" repeatCount="indefinite" type="rotate" attributeName="transform"></animateTransform>
                </circle><g></g></g></svg>
                <div class="timeState">
                    <div class="currentTime">
                        <span class="timeHour">8</span><span class="timeState-separator">:</span><span class="timeMinute">17</span>
                    </div>
                </div>
                <div class="wifiState">
                    <svg class="wifiState-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M1 9l2 2a12.73 12.73 0 0 1 18 0l2-2A15.57 15.57 0 0 0 1 9zm8 8l3 3 3-3c-1.65-1.66-4.34-1.66-6 0zm-4-4l2 2c2.76-2.76 7.24-2.76 10 0l2-2C15.14 9.14 8.87 9.14 5 13z" fill="#2E2E2E"/></svg>
                </div>
                <div id="batteryPercent"></div>
                <div class="batteryState">
                    <div class="batteryLevel" style="width: 0%;"></div>
                    <div class="batteryCharging">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve"><path xmlns="http://www.w3.org/2000/svg" fill="orange" fill-rule="evenodd" d="M30 6a2 2 0 0 0-3.548-1.266l-20 22A2 2 0 0 0 8 30h10v12a2 2 0 0 0 3.548 1.266l20-22A2 2 0 0 0 40 18H30z" clip-rule="evenodd"></path></svg>
                    </div>
                </div>
        </header>

        <main class="homeBody pending">
            <div class="appheaders">
            <span class="appheader lined">Games</span>
            <span class="appheader">Media</span>
            </div>
            <div class="appList" style="display: none;">
            </div>
            <div class="gameList">
            </div>
            <div class="mediaList" style="display: none;">
            </div>
            <div class="footerNavigation pending">
                <button id="scanFB"  data-trm="ariaLabel" data-loc="scanFB" class="footerButton refresh" aria-label="Refresh Library">
                    <img class="footerButton-icon" src="assets/img/refresh.png" alt="refresh-icon">
                </button>
                <button id="storeFB" data-trm="ariaLabel" data-loc="storeFB" class="footerButton store" aria-label="Store">
                    <img class="footerButton-icon" src="assets/vector/store.svg" alt="store-icon">
                </button>
                <!--button id="downloadFB" data-trm="ariaLabel" data-loc="Downloads" class="footerButton download" aria-label="Downloads">
                    <img class="footerButton-icon" src="assets/vector/download.svg" alt="download-icon">
                </button-->
                <button id="mediaFB" data-trm="ariaLabel" data-loc="Media" class="footerButton media" aria-label="Media">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" width="50px" height="50px"><g xmlns="http://www.w3.org/2000/svg" transform="scale(1.33333)"><path d="M32.12 10H3.88A1.88 1.88 0 0 0 2 11.88v18.24A1.88 1.88 0 0 0 3.88 32h28.24A1.88 1.88 0 0 0 34 30.12V11.88A1.88 1.88 0 0 0 32.12 10M32 30H4V12h28z" class="clr-i-outline clr-i-outline-path-1" fill="blue"></path><path d="M30.14 3a1 1 0 0 0-1-1h-22a1 1 0 0 0-1 1v1h24z" class="clr-i-outline clr-i-outline-path-2" fill="blue"></path><path d="M32.12 7a1 1 0 0 0-1-1h-26a1 1 0 0 0-1 1v1h28z" class="clr-i-outline clr-i-outline-path-3" fill="blue"></path><path d="M12.82 26.79a1.74 1.74 0 0 0 .93.28 1.7 1.7 0 0 0 .69-.15l9.77-4.36a1.69 1.69 0 0 0 0-3.1l-9.77-4.36a1.7 1.7 0 0 0-2.39 1.55v8.72a1.7 1.7 0 0 0 .77 1.42m.63-10.14a.29.29 0 0 1 .14-.25.3.3 0 0 1 .16 0 .3.3 0 0 1 .12 0l9.77 4.35a.29.29 0 0 1 .18.28.28.28 0 0 1-.18.27l-9.77 4.36a.28.28 0 0 1-.28 0 .31.31 0 0 1-.14-.25z" class="clr-i-outline clr-i-outline-path-4" fill="blue"></path><path fill="none" d="M0 0h36v36H0z"></path></g></svg>
                </button>
                <button id="controllerFB" data-trm="ariaLabel" data-loc="ControlCenter" class="footerButton controller" aria-label="Control Center">
                    <!-- svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" width="50px" height="50px"><path xmlns="http://www.w3.org/2000/svg" d="M6 26h16V6H6zm0 16h16V30H6zm20 0h16V22H26zm0-36v12h16V6z"></path></svg-->
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" width="64px" height="64px"><g xmlns="http://www.w3.org/2000/svg" fill="none" transform="scale(2)"><path fill="#707676" d="m17.657 11.293-1.414 1.414L12 8.464l-4.243 4.243-1.414-1.414L12 5.636z"></path><path fill="#707676" d="m17.657 16.95-1.414 1.414L12 14.12l-4.243 4.243-1.414-1.414L12 11.293z"></path></g></svg>
                <button id="settingsFB" data-trm="ariaLabel" data-loc="settingsFB" class="footerButton settings" aria-label="System Settings">
                    <svg class="footerButton-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M83.285,52.4V46.9H73.1a23.155,23.155,0,0,0-4.83-11.633l7.208-7.209-3.888-3.888-7.209,7.208a23.155,23.155,0,0,0-11.633-4.83V16.361h-5.5V26.544a23.155,23.155,0,0,0-11.633,4.83l-7.209-7.208L24.52,28.054l7.208,7.209A23.155,23.155,0,0,0,26.9,46.9H16.715v5.5H26.9a23.157,23.157,0,0,0,4.829,11.633L24.52,71.237l3.888,3.889,7.209-7.209a23.146,23.146,0,0,0,11.633,4.83V82.931h5.5V72.747a23.146,23.146,0,0,0,11.633-4.83l7.209,7.209,3.888-3.889-7.208-7.208A23.157,23.157,0,0,0,73.1,52.4ZM50,67.415A17.77,17.77,0,1,1,67.77,49.646,17.79,17.79,0,0,1,50,67.415Z" fill="#707676"/></svg>
                </button>
                <button id="powerFB" data-trm="ariaLabel" data-loc="powerFB" class="footerButton power" aria-label="Power">
                    <svg class="footerButton-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M79.8,49.646A29.8,29.8,0,1,1,39.125,21.913v6.015a24.3,24.3,0,1,0,21.75,0V21.913A29.84,29.84,0,0,1,79.8,49.646ZM52.75,15.038h-5.5V44.6h5.5Z" fill="#707676"/></svg>
                </button>
            </div>
        </main>
        <div class="contextualMenu" id="gameContextMenu">
            <div class="contextItem selected" id="fvOption" onclick='setGameProperty("favorite", appLaunchers[currentIndex].dataset.gameid)'>Add as favorite</div>
            <div class="contextItem" id="blOption" onclick='setGameProperty("blacklist", appLaunchers[currentIndex].dataset.gameid)'>Blacklist game</div>
        </div>
        <div class="contextualMenu" id="videoContextMenu">
            <div class="contextItem selected" id="deleteVideoOption" data-loc="id" data-trm="swapText" onclick='deleteVideo(mediaItems[currentMedia])'>Delete video</div>
        </div>
        <div class="contextualMenu" id="resumeContextMenu">
            <div class="contextItem selected" id="resumeMediaOption" data-loc="id" data-trm="swapText" onclick='playVideo(mediaItems[currentMedia].id, mediaItems[currentMedia].dataset.resume)'>Resume from where i left it</div>
            <div class="contextItem" id="restartMediaOption" data-loc="id" data-trm="swapText" onclick='playVideo(mediaItems[currentMedia].id)'>Start from beginning</div>
        </div>
        <div class="contextualMenu" id="emptyContext" style="opacity: 0.9;">
            <div id="emptyMessage" data-loc="id" data-trm="swapText" style="margin: 50px 50px 50px 50px">There's nothing to display here</div>
        </div>
        <div class="contextualMenu" id="storeContextMenu">
            <div class="contextItem selected" id="steamContext" onclick='openThirdPartyStore("steam")'>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" width="32px" height="32px">
                    <path xmlns="http://www.w3.org/2000/svg" fill="currentColor" d="M24.008 4C13.508 4 4.896 12.1 4.08 22.394l10.72 4.432a5.6 5.6 0 0 1 3.186-.984q.158.002.314.01l4.768-6.904v-.098c0-4.16 3.38-7.54 7.54-7.54s7.54 3.384 7.54 7.544-3.384 7.542-7.54 7.542h-.174l-6.794 4.852.006.266a5.65 5.65 0 0 1-5.65 5.66 5.68 5.68 0 0 1-5.55-4.546L4.77 29.45C7.146 37.844 14.854 44 24.01 44c11.044 0 19.996-8.954 19.996-20S35.052 4 24.008 4m-9.852 29.334a4.25 4.25 0 0 0 2.188 2.082 4.252 4.252 0 0 0 3.268-7.844 4.24 4.24 0 0 0-3.13-.05l2.538 1.05a3.126 3.126 0 0 1 1.68 4.092 3.126 3.126 0 0 1-4.088 1.686zm21.48-14.49a5.03 5.03 0 0 0-5.026-5.024 5.028 5.028 0 0 0 0 10.05 5.026 5.026 0 0 0 5.024-5.026zM30.62 15.06a3.778 3.778 0 1 1-.004 7.548 3.778 3.778 0 0 1 .004-7.548"></path>
                </svg>&nbsp;Steam
            </div>
            <!--div class="contextItem" id="mukkuruStoreContext" onclick='window.location.replace("/frontend/store")'>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" width="40px" height="40px"><g xmlns="http://www.w3.org/2000/svg" fill="none" transform="scale(1.6)"><path d="M24 0v24H0V0zM12.593 23.258l-.011.002-.071.035-.02.004-.014-.004-.071-.035q-.016-.005-.024.005l-.004.01-.017.428.005.02.01.013.104.074.015.004.012-.004.104-.074.012-.016.004-.017-.017-.427q-.004-.016-.017-.018m.265-.113-.013.002-.185.093-.01.01-.003.011.018.43.005.012.008.007.201.093q.019.005.029-.008l.004-.014-.034-.614q-.005-.019-.02-.022m-.715.002a.02.02 0 0 0-.027.006l-.006.014-.034.614q.001.018.017.024l.015-.002.201-.093.01-.008.004-.011.017-.43-.003-.012-.01-.01z"></path><path fill="currentColor" d="M2 9a3 3 0 0 1 3-3h2.853c.297 0 .48-.309.366-.583A2.5 2.5 0 0 1 8.083 5c-.331-1.487.792-3 2.417-3 1.626 0 2.748 1.513 2.417 3a2.5 2.5 0 0 1-.136.417c-.115.274.069.583.366.583H15a3 3 0 0 1 3 3v1.853c0 .297.308.48.583.366.135-.056.273-.104.417-.136 1.487-.331 3 .791 3 2.417s-1.513 2.748-3 2.417a2.5 2.5 0 0 1-.417-.136c-.274-.115-.583.069-.583.366V19a3 3 0 0 1-3 3h-1.893c-.288 0-.473-.291-.39-.566q.063-.21.085-.434a2.31 2.31 0 1 0-4.604 0q.021.224.086.434c.082.275-.103.566-.39.566H5a3 3 0 0 1-3-3v-2.893c0-.288.291-.473.566-.39q.21.063.434.085a2.31 2.31 0 1 0 0-4.604q-.224.021-.434.086c-.275.082-.566-.103-.566-.39z"></path></g>
                </svg>Mukkuru
            </div -->
        </div>
        <div class="contextualMenu" id="controlContextMenu">
            <img id="dashboardQR" src="web/qrcode" width="50%" height="50%" style="display: none;">
            <div class="contextItem selected" id="sOption" onclick='serverHandle("auto")'>Enable server</div>
            <div class="contextItem" id="autoPlayOption" data-on="AutoPlay enabled" data-off="AutoPlay disabled" onclick='handleAutoPlay("auto")'>Autoplay</div>
        </div>
        <div class="contextualMenu" id="powerDownContextMenu">
            <div class="contextItem selected" id="exitMukkuruBtn" data-loc="exitMukkuru" data-trm="patchHTML" data-patch="Exit Mukkuru" onclick="exitMukkuru()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" width="32px" height="32px">
                    <path xmlns="http://www.w3.org/2000/svg" fill="currentColor" fill-rule="evenodd" d="M8 30h4v10h24V8H12v10H8V6a2 2 0 0 1 2-2h28a2 2 0 0 1 2 2v36a2 2 0 0 1-2 2H10a2 2 0 0 1-2-2zm12-8v-6l10 8-10 8v-6H4v-4z"></path>
                </svg>&nbsp;Exit Mukkuru</div>
                <div class="contextItem" id="restartAppBtn" data-loc="restartMukkuru" data-trm="patchHTML" data-patch="Restart Mukkuru" onclick="restartMukkuru()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" width="32px" height="32px">
                    <path xmlns="http://www.w3.org/2000/svg" fill="currentColor" fill-rule="evenodd" d="M38.25 24a13.5 13.5 0 0 1-25.83 5.502l-4.173 1.695A18.003 18.003 0 0 0 42.75 24 18 18 0 0 0 10.5 13.002V7.5H6v12l2.25 2.25h10.5v-4.5h-5.694A13.5 13.5 0 0 1 38.25 24" clip-rule="evenodd"></path>
                </svg>&nbsp;Restart Mukkuru</div>
        </div>
        <footer class="homeFooter pending">
            <div class="controllerState">
                <div class="controllerState-type">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 184.689 100"><path d="M158 14.466H26.692a16.047 16.047 0 0 0-16 16v39.068a16.047 16.047 0 0 0 16 16H158a16.047 16.047 0 0 0 16-16V30.466a16.047 16.047 0 0 0-16-16zm.8 10.31a3.359 3.359 0 1 1-3.359 3.358 3.357 3.357 0 0 1 3.359-3.358zm0 13.969a3.359 3.359 0 1 1-3.36 3.355 3.358 3.358 0 0 1 3.36-3.355zM26.691 26.786a6.177 6.177 0 1 1-6.177 6.177 6.177 6.177 0 0 1 6.177-6.177zm-7.263 33.04a3.359 3.359 0 1 1 3.359-3.358 3.358 3.358 0 0 1-3.359 3.358zm7.263 7.253a3.359 3.359 0 1 1 3.358-3.359 3.359 3.359 0 0 1-3.358 3.359zm0-13.97a3.359 3.359 0 1 1 3.358-3.358 3.359 3.359 0 0 1-3.358 3.358zm7.109 6.717a3.359 3.359 0 1 1 3.358-3.358 3.359 3.359 0 0 1-3.358 3.358zm105.42 17.14H43.958v-52.19h95.262zm9.108-41.579a3.359 3.359 0 1 1 3.358 3.358 3.358 3.358 0 0 1-3.358-3.358zM158.8 65.068a6.177 6.177 0 1 1 6.177-6.177 6.177 6.177 0 0 1-6.177 6.177zm7.263-26.323a3.359 3.359 0 1 1 3.358-3.358 3.359 3.359 0 0 1-3.359 3.358z" fill="2E2E2E"/></svg>
                </div>
            </div>
            <div class="keyGuideList pending">
                <div class="keyGuide" id="options-keyGuide">
                    <svg class="keyGuide-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,16.715A33.285,33.285,0,1,0,83.285,50,33.285,33.285,0,0,0,50,16.715Zm19.731,36.5H53.213V69.731H46.787V53.213H30.269V46.787H46.787V30.269h6.426V46.787H69.731Z" fill="2E2E2E"/></svg>
                    <div class="keyGuide-text" id="options-keyText">
                        Options
                    </div>
                </div>
                <div class="keyGuide" id="back-keyGuide">
                    <svg class="keyGuide-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M59.765 57.536a5.611 5.611 0 0 1-.821 3.15 6.024 6.024 0 0 1-2.171 1.985 9.644 9.644 0 0 1-3.016 1.029 19.232 19.232 0 0 1-3.309.291h-6.564V51.237h7.041a12.05 12.05 0 0 1 6.563 1.482 5.319 5.319 0 0 1 2.277 4.817zm-6.22-11.09a7 7 0 0 0 2.355-1.058 5.194 5.194 0 0 0 1.588-1.8 5.473 5.473 0 0 0 .582-2.62 4.6 4.6 0 0 0-2.222-4.315 11.857 11.857 0 0 0-5.982-1.3h-5.982v11.438h6.829a11.355 11.355 0 0 0 2.832-.345zM83.285 50A33.285 33.285 0 1 1 50 16.715 33.285 33.285 0 0 1 83.285 50zm-18.227 7.8a9.861 9.861 0 0 0-.609-3.547 8.167 8.167 0 0 0-1.72-2.752 8.707 8.707 0 0 0-2.647-1.88 10.89 10.89 0 0 0-3.335-.926v-.105a9.181 9.181 0 0 0 4.765-2.911 7.815 7.815 0 0 0 1.8-5.241 8.939 8.939 0 0 0-1.033-4.5 8.572 8.572 0 0 0-2.7-2.912 11.221 11.221 0 0 0-3.779-1.587 19.281 19.281 0 0 0-4.235-.475H38.644V68.44h12.334a21.8 21.8 0 0 0 5.478-.662 14.093 14.093 0 0 0 4.473-1.958 9.277 9.277 0 0 0 4.129-8.02z" fill="2e2e2e"/></svg>
                    <div class="keyGuide-text" id="back-keyText">
                        Back
                    </div>
                </div>
                <div class="keyGuide">
                    <svg class="keyGuide-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M49.83,36.051l6.987,17.574H42.79ZM83.285,50A33.285,33.285,0,1,1,50,16.715,33.285,33.285,0,0,1,83.285,50ZM68.463,67.44,52.371,29.964H47.607L31.356,67.44h5.823l3.759-9.211H58.724l3.81,9.211Z" fill="2E2E2E"/></svg>
                    <div id="start-keyGuide" class="keyGuide-text">
                        Start
                    </div>
                </div>
            </div>
        </footer>
    </div>
    <div class="overlay" id="overlay">
        <div class="message" id="overlay-message" data-trm="swapText" data-loc="deadBackendMsg">Mukkuru backend is no longer running... restart app</div>
    </div>
</body>
    
</html>